<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="LIME OPENCHOT"
      content="Githubèªè¨¼ã‚’æ´»ç”¨ã—ã¦æ²ç¤ºæ¿ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¾ã—ã‚‡ã†ï¼"
    />
    <title>æƒ…å ±äº¤æ›æ²ç¤ºæ¿ï½œLIME OPENCHOT</title>
    <link rel="stylesheet" href="css/destyle.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="img/favicon.png" id="favicon" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </head>
  <body>
    <header>
      <div>
        <h1><a href="index.html">LIME OPENCHOT</a></h1>
      </div>
    </header>
    <main>
      <section class="mainpage">
        <!-- <div class="profile">
          <img src="img/github.png" alt="" />
          <p>githubã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å…¥ã‚Œã‚‹</p>
        </div> -->
        <div class="message">
          <div class="titlebox">
            <h2 class="title">æƒ…å ±äº¤æ›æ²ç¤ºæ¿</h2>
          </div>
          <div class="namebox">
            <div class="name">NAMEï¼š<input type="text" id="uname" /></div>
          </div>
          <div class="textareabox">
            <div class="textarea">
              <textarea
                id="text"
                cols="30"
                rows="10"
                placeholder="COMMENTï¼šã“ã“ã«ãƒãƒ£ãƒƒãƒˆã®å†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼"
              ></textarea>
            </div>
          </div>
          <div class="sendbox">
            <button id="send">é€ä¿¡</button>
          </div>
          <div
            id="output"
            class="output"
            style="
              overflow: auto;
              height: 300px;
              width: 100%;
              word-wrap: break-word;
              white-space: normal;
            "
          ></div>
        </div>
      </section>
    </main>
    <footer>Â©ï¸G`s ACADEMY</footer>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onChildAdded,
        remove,
        onChildRemoved,
        update,
        onChildChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.13.0/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "***********************************",
        authDomain: "*******************************",
        databaseURL: "******************************",
        projectId: "********************************",
        storageBucket: "****************************",
        messagingSenderId: "************************",
        appId: "************************************",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app); // RDBã«æ¥ç¶š
      const dbRef = ref(db, "chat"); // RDBå†…ã®ãƒãƒ£ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹

      // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§
      $("#send").on("click", function () {
        const uname = $("#uname").val();
        const text = $("#text").val();
        alert(uname + text); // ç¢ºèªç”¨
      });

      // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã¦ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§
      $("#text").on("keydown", function (e) {
        console.log(e);
        if (e.keyCode == 13) {
          const msg = {
            uname: $("#uname").val(),
            text: $("#text").val(),
          };
          const newPostRef = push(dbRef);
          set(newPostRef, msg);
        }
      });

      // Firebaseã¸ã®ãƒ‡ãƒ¼ã‚¿ç™»éŒ²
      $("#send").on("click", function () {
        const msg = {
          uname: $("#uname").val(),
          text: $("#text").val(),
        };
        const newPostRef = push(dbRef);
        set(newPostRef, msg);
      });

      // å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
      onChildAdded(dbRef, function (data) {
        const msg = data.val();
        const key = data.key; //å‰Šé™¤ã¨æ›´æ–°ã«å¿…é ˆ
        let h = '<p id="' + key + '"  class="outputtext" >';
        h += "NAMEï¼š" + msg.uname;
        h += "<br>";
        h +=
          '<span contentEditable="true" id="' +
          key +
          '_update">' +
          "COMMENTï¼š" +
          msg.text +
          "</span>";
        h += '<span class="remove" data-key="' + key + '"><ğŸš®></span>';
        h += '<span class="update" data-key="' + key + '"><ğŸ†•></span>';
        h += "</p>";
        $("#output").prepend(h); //prependã¯ä¸Šã«appendãªã‚‰ä¸‹ã«è¿½åŠ 
      });

      //å‰Šé™¤å®Ÿè¡Œ
      $("#output").on("click", ".remove", function () {
        const key = $(this).attr("data-key");
        const remove_item = ref(db, "chat/" + key);
        remove(remove_item); //FIREBASEã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      });

      //æ›´æ–°å®Ÿè¡Œ
      $("#output").on("click", ".update", function () {
        const key = $(this).attr("data-key");
        update(ref(db, "chat/" + key), {
          text: $("#" + key + "_update").html(),
        });
      });

      //å‰Šé™¤å‡¦ç†ã®Firebaseå´ã‚¤ãƒ™ãƒ³ãƒˆ
      onChildRemoved(dbRef, (data) => {
        $("#" + data.key).remove(); //DOMé–¢æ•°
      });

      //æ›´æ–°å‡¦ç†ã®Firebaseå´ã‚¤ãƒ™ãƒ³ãƒˆ
      onChildChanged(dbRef, (data) => {
        $("#" + data.key + "_update").html(data.val().text);
        $("#" + data.key + "_update")
          .fadeOut(800)
          .fadeIn(800);
      });
    </script>
  </body>
</html>
